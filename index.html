<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Planif IA – Gestion des Projets et Affectation (v5.1)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Styles CSS (revus pour la clarté du résultat) */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      padding: 24px;
    }
    .app {
      max-width: 1600px;
      margin: 0 auto;
    }
    header { margin-bottom: 24px; }
    header h1 { font-size: 1.8rem; margin-bottom: 6px; }
    header p { font-size: 0.95rem; color: #9ca3af; }
    .tagline { font-size: 0.8rem; color: #64748b; margin-top: 4px; }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1.8fr; /* 3 colonnes conservées */
      gap: 24px;
      align-items: flex-start;
    }
    .card {
      background: #020617;
      border-radius: 16px;
      padding: 20px;
      border: 1px solid #1f2937;
      box-shadow: 0 18px 40px rgba(0,0,0,0.5);
      min-height: 400px;
    }
    .card h2 { font-size: 1.15rem; margin-bottom: 8px; }
    .card small { color: #6b7280; font-size: 0.75rem; }
    label { display: block; font-size: 0.8rem; margin-bottom: 4px; color: #9ca3af; }
    select, input:not([type="checkbox"]), textarea {
      width: 100%;
      padding: 6px 8px;
      margin-bottom: 8px;
      border-radius: 10px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.85rem;
      resize: vertical;
    }
    input[type="date"] { padding: 5px 8px; }

    select:focus, input:focus, textarea:focus { outline: 2px solid #38bdf8; border-color: #38bdf8; }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.85rem;
      cursor: pointer;
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: white;
      font-weight: 500;
      margin-top: 6px;
      transition: all 0.2s;
    }
    button:hover { opacity: 0.95; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(56, 189, 248, 0.3); }
    .btn-secondary {
      background: #111827;
      border: 1px solid #374151;
      margin-left: 6px;
      color: #e5e7eb;
    }
    .btn-secondary:hover { box-shadow: none; border-color: #4b5563; transform: translateY(0); }
    
    /* Colonnes de listes */
    .projects-list, .fixed-list {
      max-height: 250px;
      overflow-y: auto;
      padding-right: 10px;
      font-size: 0.8rem;
    }
    .projects-list::-webkit-scrollbar, .fixed-list::-webkit-scrollbar { width: 6px; }
    .projects-list::-webkit-scrollbar-thumb, .fixed-list::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }

    /* Project Management List */
    .project-management-list {
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        max-height: 400px;
        overflow-y: auto;
        padding-right: 5px;
        font-size: 0.8rem;
    }
    .project-management-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 10px;
        background: #0f172a;
        border-radius: 8px;
        border: 1px solid #1e293b;
    }
    .project-management-item-details { flex-grow: 1; margin-right: 10px; }
    .project-management-item strong { font-size: 0.9rem; display: block; }
    .project-management-item small { color: #9ca3af; }
    .project-management-actions button { margin: 0 0 0 4px; padding: 4px 8px; font-size: 0.75rem; }
    
    /* Styles pour la gestion des données */
    .data-status { margin-top: 8px; padding: 8px; border-radius: 6px; font-size: 0.8rem; }
    .data-status.success { background: #166534; color: #dcfce7; }
    .data-status.error { background: #991b1b; color: #fee2e2; }
    .data-controls { margin-top: 10px; }
    .data-controls button { margin-top: 0; }
    .data-area textarea { height: 200px; font-family: monospace; font-size: 0.75rem; }

    /* Styles de Résultat (Result Display Styles - Detailed) */
    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .project-block {
      border-top: 1px solid #1f2937;
      padding-top: 10px;
      margin-top: 10px;
    }
    .project-block:first-of-type {
      border-top: none;
      padding-top: 0;
      margin-top: 0;
    }
    .project-block-title {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
      gap: 8px;
    }
    .project-block-title h3 {
      font-size: 0.95rem;
    }
    .project-block-title span {
      font-size: 0.75rem;
      color: #9ca3af;
    }
    .assignment-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .assignment-card {
      background: #0f172a;
      border-radius: 12px;
      padding: 10px;
      border: 1px solid #1e293b;
      font-size: 0.8rem;
    }
    .fixed-assignment {
      border: 1px solid #fde047;
      background: #422006;
    }
    .assignment-top {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
      align-items: center;
    }
    .assignment-top span.name {
      font-weight: 600;
      font-size: 0.9rem;
    }
    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 4px;
      color: #9ca3af;
    }
    .pill-row span {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #374151;
      font-size: 0.75rem;
    }
    .assignment-detail {
      color: #94a3b8;
      line-height: 1.4;
      margin-top: 8px; /* Added spacing */
    }
    .assignment-detail ul {
        margin-left: 15px;
        padding-left: 0;
        font-size: 0.75rem;
        list-style-type: disc;
    }
    .assignment-detail ul li {
        margin-top: 2px;
    }
    .no-assign {
      font-size: 0.8rem;
      color: #f97373;
      margin-bottom: 4px;
      padding: 8px 10px;
      border: 1px dashed #f97373;
      border-radius: 8px;
    }
    .score-bar-container {
      background: #1e293b;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 4px;
      height: 8px;
    }
    .score-bar {
      height: 100%;
      background: linear-gradient(90deg, #38bdf8, #16a34a);
      width: 0%;
      transition: width 0.3s ease-out;
    }
    .score-label {
      font-size: 0.7rem;
      color: #e5e7eb;
      font-weight: 700;
    }
    
    /* Directive List Styles (kept detailed) */
    .fixed-item-error { color: #f97373; font-size: 0.75rem; margin-top: 2px; margin-bottom: 4px; }
    .fixed-item-solution { font-size: 0.75rem; color: #38bdf8; background: #0c4a6e30; border: 1px solid #0c4a6e; padding: 4px 6px; border-radius: 6px; margin-top: 4px; }
    .fixed-item-success { color: #34d399; }
    .fixed-item-content { flex-grow: 1; }
    .fixed-item span { color: #e5e7eb; font-weight: 500; }
    .fixed-item { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; border-bottom: 1px dashed #1f2937;}
    .fixed-item:last-child { border-bottom: none; }
    .delete-fixed-btn { background: #ef4444; color: white; border: none; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; padding: 0; line-height: 1; margin-left: 10px; cursor: pointer; transition: background-color 0.2s; flex-shrink: 0; }

    @media (max-width: 1400px) {
      .grid { grid-template-columns: 1fr 1fr; }
      .grid > section:last-child { grid-column: 1 / span 2; }
    }
    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
      .grid > section:last-child { grid-column: 1 / span 1; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Planificateur IA – Affectation globale (v5.1)</h1>
      <p>
        **Mode Gestion des Projets par Formulaire Actif.** Modifiez, ajoutez ou supprimez des projets via l'interface ci-dessous.
      </p>
      <div class="tagline">
        Priorité : **Disponibilité** > Compétences > Évaluation > Distance.
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <h2>1. Planification & Directives</h2>
        <small id="databaseSummary">Base de données : N/A</small>
        
        <div style="margin-top:10px; margin-bottom:4px;">
          <button id="planAllBtn">Générer une nouvelle planification (IA)</button>
        </div>
        <small style="display:block;margin-top:2px;color:#6b7280;font-size:0.75rem;">
          L'IA utilisera les données chargées.
        </small>

        <div style="margin-top:16px; border-top:1px solid #1f2937; padding-top:12px;">
          <h3 style="font-size:0.95rem;margin-bottom:4px;">Directive fixe (Manuelle)</h3>

          <label style="margin-top:8px;">Projet</label>
          <select id="fixedProjectSelect"></select>

          <label>Employé</label>
          <select id="fixedEmployeeSelect"></select>

          <button id="addFixedBtn">Ajouter la directive</button>
          <button id="clearFixedBtn" class="btn-secondary">Effacer toutes les directives</button>

          <div class="fixed-list" id="fixedList">
            Aucune directive pour l’instant.
          </div>
        </div>
        
        <div style="margin-top:24px; border-top:1px solid #1f2937; padding-top:12px;">
            <h3 style="font-size:0.95rem;">Projets chargés (Aperçu)</h3>
        </div>
        <div class="projects-list" id="projectsList"></div>
      </section>

      <section class="card data-management">
        <h2>2. Gestion de la Base de Données</h2>
        
        <div class="data-controls">
            <button id="loadDataBtn">Mettre à jour la base de données</button>
            <button id="saveDataBtn" class="btn-secondary">Sauvegarder (Localement)</button>
            <button id="resetDataBtn" class="btn-secondary">Réinitialiser (Données par défaut)</button>
        </div>
        <div id="dataStatus" class="data-status">Prêt.</div>
        
        <h3 style="font-size:1.15rem; margin-top:20px; color: #38bdf8;">2.5 Gestion Manuelle</h3>

        <div style="margin-top:16px; border-top:1px solid #1f2937; padding-top:12px;">
            <h3 style="font-size:1rem; margin-bottom:10px;">Gestion des Projets (Formulaire)</h3>
            
            <label for="projectIdInput">ID Projet (P-XXX) <small style="color:#fde047; margin-left:10px;" id="currentProjectEditStatus">Nouveau Projet</small></label>
            <input type="text" id="projectIdInput" placeholder="Ex: P-999" required />

            <label for="projectNomInput">Nom du Projet</label>
            <input type="text" id="projectNomInput" placeholder="Ex: Arrêt usine X" required />
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div>
                    <label for="projectMetierSelect">Métier Requis</label>
                    <select id="projectMetierSelect">
                        <option value="mecanicien">mecanicien</option>
                        <option value="soudeur">soudeur</option>
                        <option value="tuyauteur">tuyauteur</option>
                        <option value="manoeuvre">manoeuvre</option>
                    </select>
                </div>
                <div>
                    <label for="projectSlotsInput">Nombre de Postes (Slots)</label>
                    <input type="number" id="projectSlotsInput" min="1" max="10" value="3" required />
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div>
                    <label for="projectDebutInput">Date de Début</label>
                    <input type="date" id="projectDebutInput" required />
                </div>
                <div>
                    <label for="projectFinInput">Date de Fin</label>
                    <input type="date" id="projectFinInput" required />
                </div>
            </div>

            <label for="projectCompetencesInput">Compétences Requises (séparées par une virgule)</label>
            <input type="text" id="projectCompetencesInput" placeholder="Ex: MIG, Lecture plan, ASP" required />

            <div style="display:flex; justify-content: flex-end; margin-top: 5px;">
                <button id="saveProjectBtn">Ajouter / Mettre à jour le projet</button>
                <button id="cancelEditBtn" class="btn-secondary" style="display:none;">Annuler l'édition</button>
            </div>
        </div>

        <div style="margin-top:20px; border-top:1px solid #1f2937; padding-top:12px;">
            <h3 style="font-size:1rem;">Projets Actuellement dans la Base</h3>
            <div class="project-management-list" id="projectManagementList"></div>
        </div>
        
        <div class="data-area" style="margin-top:20px; border-top:1px solid #1f2937; padding-top:12px;">
            <label for="employeesJSON">Employés (JSON Array - Volume élevé : 150 employés) <small style="color:#fde047;">Modifier ici la 'disponibilite' ou l'évaluation.</small></label>
            <textarea id="employeesJSON"></textarea>
        </div>
      </section>

      <section class="card">
        <div class="result-header">
          <div>
            <h2>3. Résultat de la planification</h2>
            <small id="summaryText">Cliquez sur “Générer une nouvelle planification (IA)” pour commencer.</small>
          </div>
        </div>
        <div id="assignmentsContainer"></div>
      </section>
    </div>
  </div>

  <script>
    
    // ==========================================================
    // GÉNÉRATION DE DONNÉES PAR DÉFAUT
    // ==========================================================

    const allSkills = {
        mecanicien: ["Alignement", "Hydraulique", "Maintenance préventive", "Maintenance corrective", "Réducteur", "Pneumatique", "Usinage", "Montage de convoyeur", "Analyse vibration"],
        soudeur: ["MIG", "TIG", "ARC", "TIG inox", "Soudure inox", "Lecture plan", "Pont roulant", "Espaces clos", "ASP"],
        tuyauteur: ["Filetage", "Raccordement de vannes", "Lecture isométriques", "ASME B31.3", "Assemblage tuyauterie haute pression", "Soudure orbitale", "Test d'étanchéité"],
        manoeuvre: ["Manutention", "Nettoyage industriel", "Élingage de base", "Travail en hauteur", "Espaces clos", "Permis cariste", "Sécurité SIMDUT"]
    };

    const names = ["Alexandre", "Marie", "Charles", "Sophie", "David", "Julie", "Gabriel", "Audrey", "Louis", "Nadia", "Thomas", "Isabelle", "Nicolas", "Rachel", "Philippe", "Cynthia"];
    const surnames = ["Tremblay", "Gagnon", "Côté", "Bouchard", "Gauthier", "Dion", "Proulx", "Richard", "Girard", "Lapointe"];
    
    function getRandomElement(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
    }

    function getRandomSkills(metier, min, max) {
        const availableSkills = allSkills[metier];
        const count = Math.floor(Math.random() * (max - min + 1)) + min;
        const shuffled = availableSkills.sort(() => 0.5 - Math.random());
        return shuffled.slice(0, count);
    }
    
    function generateEmployees(metier, count, prefix) {
        const employees = [];
        const uniqueNames = new Set();
        const disponibilites = ["Disponible", "Disponible", "Disponible", "Sur chantier", "En congé"];

        for (let i = 1; i <= count; i++) {
            let nom;
            do {
                nom = `${getRandomElement(names)} ${getRandomElement(surnames)}`;
            } while (uniqueNames.has(nom));
            uniqueNames.add(nom);

            const id = `${prefix}-${String(i).padStart(3, '0')}`;
            const evaluation = parseFloat((Math.random() * (5.0 - 3.5) + 3.5).toFixed(1)); 
            const distanceKm = Math.floor(Math.random() * 45) + 5; 
            const competenceRange = metier === 'manoeuvre' ? { min: 2, max: 4 } : { min: 3, max: 5 };

            employees.push({
                id,
                nom,
                metier,
                competences: getRandomSkills(metier, competenceRange.min, competenceRange.max),
                disponibilite: getRandomElement(disponibilites), 
                distanceKm,
                evaluation
            });
        }
        return employees;
    }

    const initialEmployees = [
      ...generateEmployees('mecanicien', 40, 'M'),
      ...generateEmployees('soudeur', 40, 'S'),
      ...generateEmployees('tuyauteur', 35, 'T'),
      ...generateEmployees('manoeuvre', 35, 'N')
    ];
    initialEmployees.sort((a, b) => a.nom.localeCompare(b.nom));

    const initialProjects = [
      { id:"P-101", nom:"Arrêt chaudière – Bécancour", metier:"soudeur", competencesRequises:["MIG","Espaces clos","ASP"], debut:"2026-01-10", fin:"2026-01-18", slots:4 },
      { id:"P-102", nom:"Remplacement convoyeur – Trois-Rivières", metier:"mecanicien", competencesRequises:["Maintenance préventive","Alignement","Hydraulique"], debut:"2026-01-12", fin:"2026-01-25", slots:5 },
      { id:"P-103", nom:"Ligne vapeur HP – Shawinigan", metier:"tuyauteur", competencesRequises:["Lecture isométriques","ASME B31.3"], debut:"2026-01-20", fin:"2026-02-02", slots:3 },
      { id:"P-104", nom:"Nettoyage silo – Bécancour", metier:"manoeuvre", competencesRequises:["Nettoyage industriel","Espaces clos"], debut:"2026-01-15", fin:"2026-01-19", slots:4 },
      { id:"P-105", nom:"Projet inox – Québec", metier:"soudeur", competencesRequises:["TIG inox","Soudure inox","Lecture plan"], debut:"2026-02-01", fin:"2026-02-15", slots:5 },
      { id:"P-106", nom:"Maintenance usine – Laval", metier:"mecanicien", competencesRequises:["Maintenance corrective","Pneumatique","Réducteur"], debut:"2026-01-28", fin:"2026-02-10", slots:3 },
      { id:"P-107", nom:"Installation pompe – Sherbrooke", metier:"mecanicien", competencesRequises:["Hydraulique","Analyse vibration"], debut:"2026-02-05", fin:"2026-02-12", slots:2 },
      { id:"P-108", nom:"Rénovation tuyauterie – Lévis", metier:"tuyauteur", competencesRequises:["Filetage","Raccordement de vannes","Test d'étanchéité"], debut:"2026-02-10", fin:"2026-02-28", slots:5 },
      { id:"P-109", nom:"Fabrication de structures – Montréal", metier:"soudeur", competencesRequises:["MIG","Lecture plan","Pont roulant"], debut:"2026-02-18", fin:"2026-03-05", slots:4 },
      { id:"P-110", nom:"Support construction – Longueuil", metier:"manoeuvre", competencesRequises:["Manutention","Permis cariste"], debut:"2026-02-15", fin:"2026-02-25", slots:6 },
      { id:"P-111", nom:"Arrêt printemps – Sorel-Tracy", metier:"tuyauteur", competencesRequises:["Lecture isométriques","Assemblage tuyauterie haute pression","Soudure orbitale"], debut:"2026-03-01", fin:"2026-03-15", slots:4 },
      { id:"P-112", nom:"Optimisation production – Drummondville", metier:"mecanicien", competencesRequises:["Usinage","Alignement"], debut:"2026-02-20", fin:"2026-03-05", slots:2 },
      { id:"P-113", nom:"Travail en hauteur – Granby", metier:"manoeuvre", competencesRequises:["Travail en hauteur","Élingage de base"], debut:"2026-03-08", fin:"2026-03-12", slots:3 },
      { id:"P-114", nom:"Changement de ligne – Thetford Mines", metier:"soudeur", competencesRequises:["TIG","ARC","ASP"], debut:"2026-03-10", fin:"2026-03-20", slots:3 },
      { id:"P-115", nom:"Réparation Hydraulique – Saint-Jean", metier:"mecanicien", competencesRequises:["Hydraulique","Maintenance corrective"], debut:"2026-03-18", fin:"2026-03-25", slots:2 },
      { id:"P-116", nom:"Projet TIG Inox – Alma", metier:"soudeur", competencesRequises:["TIG inox","Soudure inox"], debut:"2026-03-25", fin:"2026-04-05", slots:4 },
      { id:"P-117", nom:"Déplacement machinerie – Val-d'Or", metier:"manoeuvre", competencesRequises:["Manutention","Permis cariste","Élingage de base"], debut:"2026-03-15", fin:"2026-03-30", slots:5 },
      { id:"P-118", nom:"Tuyauterie Process – Gaspé", metier:"tuyauteur", competencesRequises:["Raccordement de vannes","ASME B31.3","Test d'étanchéité"], debut:"2026-03-28", fin:"2026-04-10", slots:3 },
      { id:"P-119", nom:"Soudure haute pression – Sept-Îles", metier:"soudeur", competencesRequises:["ARC","Espaces clos"], debut:"2026-04-01", fin:"2026-04-08", slots:2 },
      { id:"P-120", nom:"Révision convoyeur – Victoriaville", metier:"mecanicien", competencesRequises:["Montage de convoyeur","Maintenance préventive","Alignement"], debut:"2026-04-05", fin:"2026-04-18", slots:4 },
      { id:"P-121", nom:"Nettoyage final – Baie-Comeau", metier:"manoeuvre", competencesRequises:["Nettoyage industriel","Sécurité SIMDUT"], debut:"2026-04-10", fin:"2026-04-15", slots:3 },
      { id:"P-122", nom:"Modernisation usine – Joliette", metier:"mecanicien", competencesRequises:["Hydraulique","Pneumatique","Réducteur"], debut:"2026-04-15", fin:"2026-04-30", slots:5 },
      { id:"P-123", nom:"Projet ASME – Boucherville", metier:"tuyauteur", competencesRequises:["ASME B31.3","Soudure orbitale"], debut:"2026-04-18", fin:"2026-04-28", slots:2 },
      { id:"P-124", nom:"Espaces Clos – Rimouski", metier:"manoeuvre", competencesRequises:["Espaces clos","Travail en hauteur"], debut:"2026-04-20", fin:"2026-04-25", slots:4 },
      { id:"P-125", nom:"Réparation Structure – Trois-Rivières", metier:"soudeur", competencesRequises:["MIG","Lecture plan"], debut:"2026-04-22", fin:"2026-04-30", slots:3 },
    ];
    
    // Variables globales
    let employees = [];
    let projects = [];
    let fixedAssignments = [];
    let isEditingProject = false; 

    // ===========================================
    // SÉLECTEURS D'ÉLÉMENTS UI
    // ===========================================
    const projectsListEl = document.getElementById("projectsList");
    const assignmentsContainer = document.getElementById("assignmentsContainer");
    const summaryText = document.getElementById("summaryText");
    const planAllBtn = document.getElementById("planAllBtn");
    const loadDataBtn = document.getElementById("loadDataBtn");
    const saveDataBtn = document.getElementById("saveDataBtn");
    const resetDataBtn = document.getElementById("resetDataBtn");
    const dataStatus = document.getElementById("dataStatus");
    const databaseSummary = document.getElementById("databaseSummary");
    const employeesJSONArea = document.getElementById("employeesJSON");
    const fixedProjectSelect = document.getElementById("fixedProjectSelect");
    const fixedEmployeeSelect = document.getElementById("fixedEmployeeSelect");
    const fixedList = document.getElementById("fixedList");

    // Sélecteurs de formulaire Projet
    const projectIdInput = document.getElementById('projectIdInput');
    const projectNomInput = document.getElementById('projectNomInput');
    const projectMetierSelect = document.getElementById('projectMetierSelect');
    const projectDebutInput = document.getElementById('projectDebutInput');
    const projectFinInput = document.getElementById('projectFinInput');
    const projectSlotsInput = document.getElementById('projectSlotsInput');
    const projectCompetencesInput = document.getElementById('projectCompetencesInput');
    const saveProjectBtn = document.getElementById('saveProjectBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const projectManagementList = document.getElementById('projectManagementList');
    const currentProjectEditStatus = document.getElementById('currentProjectEditStatus');


    // ===========================================
    // LOGIQUE DE GESTION DES DONNÉES
    // ===========================================

    function setStatus(message, isError = false) {
        dataStatus.textContent = message;
        dataStatus.className = "data-status " + (isError ? "error" : "success");
    }

    // --- Gestion des Employés (JSON) ---
    function loadEmployeesFromUI() {
        try {
            const loadedEmployees = JSON.parse(employeesJSONArea.value);
            if (!Array.isArray(loadedEmployees) || loadedEmployees.length === 0) {
                throw new Error("La liste des employés est vide ou n'est pas un tableau valide.");
            }
            employees = loadedEmployees.sort((a, b) => a.nom.localeCompare(b.nom));
            return true;
        } catch (e) {
            setStatus("Erreur JSON des employés : " + e.message, true);
            return false;
        }
    }

    // --- Gestion Globale ---
    function loadDataFromUI(showStatus = true) {
        if (!loadEmployeesFromUI()) return false;
        
        // Projects array is already managed by the form/list functions

        // Mettre à jour l'UI de Planification
        renderProjectsList();
        renderProjectManagementList();
        initFixedSelectors();
        
        databaseSummary.textContent = `Base de données : ${employees.length} employés / ${projects.length} projets.`;
        if (showStatus) {
            setStatus("Données chargées avec succès. Prêt pour la planification.");
        }
        return true;
    }

    function displayCurrentData(empData, projData) {
        employeesJSONArea.value = JSON.stringify(empData, null, 2);
        projects = projData; // Affectation directe du tableau projects
    }

    function initializeData() {
        const storedEmployees = localStorage.getItem('planif_employees');
        const storedProjects = localStorage.getItem('planif_projects');

        if (storedEmployees && storedProjects) {
            try {
                displayCurrentData(JSON.parse(storedEmployees), JSON.parse(storedProjects));
                loadDataFromUI(false);
            } catch (e) {
                // En cas d'erreur de parsing du local storage, charger les données par défaut
                displayCurrentData(initialEmployees, initialProjects);
                loadDataFromUI(false);
                setStatus("Sauvegarde locale corrompue. Chargement des données par défaut.");
            }
        } else {
            // Pas de sauvegarde locale, charger les données par défaut
            displayCurrentData(initialEmployees, initialProjects);
            loadDataFromUI(false);
        }
        
        resetProjectForm(); // Initialiser le formulaire à un état "Nouveau Projet"
    }

    function saveDataToLocalStorage() {
        // Sauvegarder les employés depuis le JSON Area
        localStorage.setItem('planif_employees', employeesJSONArea.value);
        // Sauvegarder les projets depuis le tableau JS
        localStorage.setItem('planif_projects', JSON.stringify(projects, null, 2));
        setStatus("Données sauvegardées dans le stockage local du navigateur.", false);
    }
    
    function resetDataToDefault() {
        localStorage.removeItem('planif_employees');
        localStorage.removeItem('planif_projects');
        fixedAssignments = [];
        displayCurrentData(initialEmployees, initialProjects);
        loadDataFromUI();
        renderFixedList();
        setStatus("Données réinitialisées aux valeurs par défaut.", false);
    }
    
    // ===========================================
    // LOGIQUE DE GESTION DES PROJETS PAR FORMULAIRE
    // ===========================================
    
    function resetProjectForm() {
        isEditingProject = false;
        // Generate a new ID based on the current number of projects + 1
        let nextIdNumber = projects.length + 1;
        while(projects.some(p => p.id === 'P-' + String(nextIdNumber).padStart(3, '0'))) {
             nextIdNumber++;
        }
        projectIdInput.value = 'P-' + String(nextIdNumber).padStart(3, '0');
        projectNomInput.value = '';
        projectMetierSelect.value = 'mecanicien';
        projectDebutInput.value = new Date().toISOString().substring(0, 10);
        projectFinInput.value = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().substring(0, 10);
        projectSlotsInput.value = 3;
        projectCompetencesInput.value = '';
        currentProjectEditStatus.textContent = 'Nouveau Projet';
        saveProjectBtn.textContent = 'Ajouter le nouveau projet';
        cancelEditBtn.style.display = 'none';
        projectIdInput.disabled = false;
    }
    
    function editProject(projectId) {
        const project = projects.find(p => p.id === projectId);
        if (!project) return;
        
        isEditingProject = true;
        projectIdInput.value = project.id;
        projectIdInput.disabled = true; 
        projectNomInput.value = project.nom;
        projectMetierSelect.value = project.metier;
        projectDebutInput.value = project.debut;
        projectFinInput.value = project.fin;
        projectSlotsInput.value = project.slots;
        projectCompetencesInput.value = project.competencesRequises.join(', ');
        
        currentProjectEditStatus.textContent = `Édition de ${project.id}`;
        saveProjectBtn.textContent = 'Mettre à jour le projet';
        cancelEditBtn.style.display = 'inline-block';
        
        // Scroll to the top of the form for better UX
        document.getElementById('projectIdInput').scrollIntoView({ behavior: 'smooth' });
    }
    
    function saveProject() {
        const id = projectIdInput.value.trim();
        const nom = projectNomInput.value.trim();
        const metier = projectMetierSelect.value;
        const debut = projectDebutInput.value;
        const fin = projectFinInput.value;
        const slots = parseInt(projectSlotsInput.value, 10);
        const competencesRequises = projectCompetencesInput.value.split(',').map(c => c.trim()).filter(c => c.length > 0);
        
        if (!id || !nom || !debut || !fin || isNaN(slots) || slots < 1) {
            setStatus("Veuillez remplir tous les champs du projet (ID, Nom, Dates, Slots > 0).", true);
            return;
        }

        const newProject = {
            id,
            nom,
            metier,
            competencesRequises,
            debut,
            fin,
            slots
        };

        if (isEditingProject) {
            // Update
            const index = projects.findIndex(p => p.id === id);
            if (index !== -1) {
                projects[index] = newProject;
                setStatus(`Projet ${id} mis à jour avec succès.`, false);
            } else {
                setStatus(`Erreur: Projet ${id} introuvable pour la mise à jour.`, true);
            }
        } else {
            // Add new
            if (projects.some(p => p.id === id)) {
                 setStatus(`Erreur: Un projet avec l'ID ${id} existe déjà.`, true);
                 return;
            }
            projects.push(newProject);
            setStatus(`Nouveau projet ${id} ajouté.`, false);
        }
        
        resetProjectForm();
        loadDataFromUI(false); // Reload all UI lists and selectors
    }
    
    function deleteProject(projectId) {
        if (confirm(`Êtes-vous sûr de vouloir supprimer le projet ${projectId}?`)) {
            projects = projects.filter(p => p.id !== projectId);
            
            // Remove directives related to this project
            fixedAssignments = fixedAssignments.filter(d => d.projectId !== projectId);
            
            setStatus(`Projet ${projectId} supprimé.`, false);
            loadDataFromUI(false);
            renderFixedList();
            
            if(isEditingProject && projectIdInput.value === projectId) {
                resetProjectForm();
            }
        }
    }
    
    function renderProjectManagementList() {
        projectManagementList.innerHTML = '';
        if (projects.length === 0) {
            projectManagementList.innerHTML = '<p style="color:#9ca3af; font-style:italic;">Aucun projet dans la base de données.</p>';
            return;
        }
        
        const sorted = [...projects].sort((a, b) => a.id.localeCompare(b.id));

        sorted.forEach(p => {
            const div = document.createElement('div');
            div.className = 'project-management-item';
            div.innerHTML = `
                <div class="project-management-item-details">
                    <strong>${p.id} – ${p.nom}</strong>
                    <small>${p.metier} | ${p.slots} postes | ${p.debut} → ${p.fin}</small>
                </div>
                <div class="project-management-actions">
                    <button class="edit-project-btn btn-secondary" data-id="${p.id}">Éditer</button>
                    <button class="delete-project-btn" data-id="${p.id}">Supprimer</button>
                </div>
            `;
            projectManagementList.appendChild(div);
        });
        
        // Add event listeners
        projectManagementList.querySelectorAll('.edit-project-btn').forEach(btn => {
            btn.addEventListener('click', (e) => editProject(e.target.dataset.id));
        });
        projectManagementList.querySelectorAll('.delete-project-btn').forEach(btn => {
            btn.addEventListener('click', (e) => deleteProject(e.target.dataset.id));
        });
    }

    // ===========================================
    // LOGIQUE DE PLANIFICATION (INCHANGÉE)
    // ===========================================

    function parseDate(str) { return new Date(str + "T00:00:00"); }
    function projectsOverlap(p1, p2) {
      const s1 = parseDate(p1.debut);
      const e1 = parseDate(p1.fin);
      const s2 = parseDate(p2.debut);
      const e2 = parseDate(p2.fin);
      if (e1 < s2 || e2 < s1) return false;
      return true;
    }
    function shuffleArray(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }
    function removeFixedAssignment(index) {
      if (index >= 0 && index < fixedAssignments.length) {
        fixedAssignments.splice(index, 1);
        renderFixedList();
        summaryText.textContent = "Directive supprimée. Cliquez sur 'Générer une nouvelle planification (IA)' pour mettre à jour les affectations.";
      }
    }
    function scoreEmployeeForProject(emp, project, employeeLoad) {
      if (!emp.disponibilite || !emp.disponibilite.toLowerCase().includes("disponible")) return null; 
      if (emp.metier !== project.metier) return null;
      const required = (project.competencesRequises || []).map(c => c.toLowerCase());
      const empSkills = (emp.competences || []).map(c => c.toLowerCase());
      const matched = required.filter(r => empSkills.includes(r)).length;
      if (matched === 0 && required.length > 0) return null; 
      const competenceScore = required.length > 0 ? matched / required.length : 1; 
      const evalScore = Math.min(Math.max(emp.evaluation || 0, 0), 5) / 5;
      const maxDistance = 50;
      const distanceScore = Math.max(0, 1 - ((emp.distanceKm || maxDistance) / maxDistance));
      let baseScore = 0.5 * competenceScore + 0.3 * evalScore + 0.2 * distanceScore;
      const load = employeeLoad[emp.id] || 0;
      const loadFactor = 1 / (1 + load * 0.5);
      const finalScore = baseScore * loadFactor;
      return {
        finalScore, competenceScore, evalScore, distanceScore, matched, loadFactor
      };
    }

    function planAllProjectsGlobally() {
      if (!loadDataFromUI()) {
        assignmentsContainer.innerHTML = '<p style="color:#f97373;">Erreur de chargement des données. Veuillez corriger le JSON des employés ou vérifier la liste des projets.</p>';
        return;
      }
      if (projects.length === 0) {
        assignmentsContainer.innerHTML = '<p style="color:#f97373;">Veuillez ajouter des projets avant de lancer la planification.</p>';
        return;
      }

      assignmentsContainer.innerHTML = '<p style="color:#38bdf8;">Planification en cours...</p>';
      
      const sortedProjects = [...projects].sort((a, b) => parseDate(a.debut) - parseDate(b.debut));

      const assignments = {};
      const employeeAssignments = {};
      const employeeLoad = {};

      for (const p of sortedProjects) { assignments[p.id] = []; }
      fixedAssignments = fixedAssignments.map(d => ({ ...d, status: 'pending', reason: null, conflitProjId: null }));
      
      // 1) Appliquer d'abord les directives fixes
      for (let i = 0; i < fixedAssignments.length; i++) {
        const directive = fixedAssignments[i];
        const proj = projects.find(pr => pr.id === directive.projectId);
        const emp = employees.find(e => e.id === directive.empId);

        if (!proj || !emp) continue;

        let status = 'assigned';
        let reason = null;
        let conflitProjId = null;
        
        if (!emp.disponibilite || !emp.disponibilite.toLowerCase().includes("disponible")) {
            status = 'conflict_dispo';
            reason = `Employé non disponible (${emp.disponibilite || 'N/A'})`;
        } else if (emp.metier !== proj.metier) {
            status = 'conflict_metier';
            reason = `Métier non compatible (${emp.metier || 'N/A'} vs ${proj.metier || 'N/A'})`;
        } else if (assignments[proj.id].length >= proj.slots) {
            status = 'conflict_slots';
            reason = `Projet déjà complet (${proj.slots} slots remplis)`;
        } else {
            const alreadyForEmp = employeeAssignments[emp.id] || [];
            let conflit = false;
            for (const pid of alreadyForEmp) {
                const ap = projects.find(pr => pr.id === pid);
                if (ap && projectsOverlap(ap, proj)) {
                    conflit = true;
                    conflitProjId = ap.id;
                    reason = `Chevauchement avec ${ap.nom} (${ap.id})`;
                    break;
                }
            }

            if (conflit) {
                status = 'conflict_overlap';
                fixedAssignments[i].conflitProjId = conflitProjId;
            }
        }

        fixedAssignments[i].status = status;
        fixedAssignments[i].reason = reason;
        fixedAssignments[i].employeeName = emp.nom;
        fixedAssignments[i].projectName = proj.nom;

        if (status === 'assigned') {
            const score = scoreEmployeeForProject(emp, proj, employeeLoad) || {
                finalScore: 1.0, competenceScore: 1.0, evalScore: (emp.evaluation || 0) / 5, 
                distanceScore: Math.max(0, 1 - ((emp.distanceKm || 50) / 50)), matched: (proj.competencesRequises || []).length, loadFactor: 1 
            };
            
            assignments[proj.id].push({ emp, s: score, isFixed: true });

            if (!employeeAssignments[emp.id]) employeeAssignments[emp.id] = [];
            employeeAssignments[emp.id].push(proj.id);
            employeeLoad[emp.id] = (employeeLoad[emp.id] || 0) + 1;
        }
      }

      // 2) Compléter les slots restants avec IA + shuffle
      for (const project of sortedProjects) {
        const shuffledEmployees = shuffleArray(employees);

        for (let slot = assignments[project.id].length; slot < project.slots; slot++) {
          const candidates = [];

          for (const emp of shuffledEmployees) {
            const alreadyAssignedHere = (assignments[project.id] || []).some(a => a.emp.id === emp.id);
            if (alreadyAssignedHere) continue;

            const assignedProjects = employeeAssignments[emp.id] || [];
            let conflit = false;
            for (const pid of assignedProjects) {
              const ap = projects.find(pr => pr.id === pid);
              if (ap && projectsOverlap(ap, project)) {
                conflit = true;
                break;
              }
            }
            if (conflit) continue;

            const s = scoreEmployeeForProject(emp, project, employeeLoad);
            if (s) { candidates.push({ emp, s, isFixed: false }); }
          }

          if (candidates.length === 0) continue;

          candidates.sort((a, b) => b.s.finalScore - a.s.finalScore);
          const chosen = candidates[0];

          assignments[project.id].push(chosen);
          if (!employeeAssignments[chosen.emp.id]) employeeAssignments[chosen.emp.id] = [];
          employeeAssignments[chosen.emp.id].push(project.id);
          employeeLoad[chosen.emp.id] = (employeeLoad[chosen.emp.id] || 0) + 1;
        }
      }

      return { assignments, employeeAssignments, employeeLoad };
    }

    // ===========================================
    // RENDU UI
    // ===========================================
    
    function renderProjectsList() {
      projectsListEl.innerHTML = "";
      const sorted = [...projects].sort((a, b) => parseDate(a.debut) - parseDate(b.debut));
      for (const p of sorted) {
        const div = document.createElement("div");
        div.className = "project-line";
        div.innerHTML = `
          <strong>${p.id} – ${p.nom}</strong>
          <div class="project-meta">
            <span>Métier : ${p.metier || 'N/A'}</span>
            <span>Postes : ${p.slots || 0}</span><br/>
            <span>Dates : ${p.debut} → ${p.fin}</span>
          </div>
        `;
        projectsListEl.appendChild(div);
      }
    }

    function renderFixedList() {
      if (!fixedAssignments.length) {
        fixedList.textContent = "Aucune directive pour l’instant.";
        return;
      }
      fixedList.innerHTML = "";
      
      fixedAssignments.forEach((d, index) => { 
        const proj = projects.find(pr => pr.id === d.projectId);
        const emp = employees.find(e => e.id === d.empId);
        if (!proj || !emp) return;
        
        const div = document.createElement("div");
        div.className = "fixed-item";
        
        let statusText = '';
        let solutionText = '';
        let statusClass = 'fixed-item-success';
        
        switch(d.status) {
            case 'assigned':
                statusText = '– Affectation RESPECTÉE.';
                break;
            case 'conflict_metier':
                statusText = `– CONFLIT : Métier (${emp.metier || 'N/A'}) incompatible avec ${proj.metier || 'N/A'}.`;
                solutionText = `**Action :** Choisir un ${proj.metier} ou vérifier les compétences croisées.`;
                statusClass = 'fixed-item-error';
                break;
            case 'conflict_dispo':
                statusText = `– CONFLIT : Employé indisponible (${emp.disponibilite || 'N/A'}).`;
                solutionText = `**Action :** Mettre à jour la disponibilité de l'employé dans la section JSON ou forcer la directive (Risque RH).`;
                statusClass = 'fixed-item-error';
                break;
            case 'conflict_slots':
                statusText = `– CONFLIT : Projet déjà complet (${proj.slots} slots).`;
                solutionText = `**Action :** Désaffecter un employé IA pour faire de la place ou augmenter les slots du projet (dans Formulaire Projet).`;
                statusClass = 'fixed-item-error';
                break;
            case 'conflict_overlap':
                statusText = `– CONFLIT : Chevauchement avec le projet ${d.conflitProjId || 'N/A'}.`;
                solutionText = `**Action :** Examiner les dates. Proposer un échange d'affectation sur ${d.conflitProjId}.`;
                statusClass = 'fixed-item-error';
                break;
            default:
                statusText = '– En attente de planification.';
                statusClass = 'fixed-item';
        }

        let solutionHtml = solutionText ? `<div class="fixed-item-solution">${solutionText}</div>` : '';

        div.innerHTML = `
          <div class="fixed-item-content">
            • <span>${emp.nom}</span> doit être affecté à <span>${proj.id}</span>
            <div class="${statusClass}">
              ${statusText}
            </div>
            ${solutionHtml}
          </div>
          <button class="delete-fixed-btn" data-index="${index}">X</button>
        `;
        fixedList.appendChild(div);
      });
      
      fixedList.querySelectorAll('.delete-fixed-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const index = e.target.getAttribute('data-index'); 
          removeFixedAssignment(parseInt(index));
        });
      });
    }

    function renderAssignments(result) {
      const { assignments, employeeAssignments, employeeLoad } = result;

      let totalSlots = projects.reduce((sum, p) => sum + (p.slots || 0), 0);
      let totalAssigned = Object.values(assignments).reduce((sum, arr) => sum + arr.length, 0);

      summaryText.textContent =
        `Postes remplis : ${totalAssigned}/${totalSlots} • ` +
        `Employés utilisés : ${Object.keys(employeeAssignments).length}/${employees.length}`;

      assignmentsContainer.innerHTML = "";

      const sorted = [...projects].sort((a, b) => parseDate(a.debut) - parseDate(b.debut));

      for (const p of sorted) {
        const block = document.createElement("div");
        block.className = "project-block";

        const title = document.createElement("div");
        title.className = "project-block-title";
        title.innerHTML = `
          <h3>${p.id} – ${p.nom}</h3>
          <span>${p.debut} → ${p.fin} • ${p.metier} • ${p.slots} postes</span>
        `;

        block.appendChild(title);

        const list = document.createElement("div");
        list.className = "assignment-list";

        const assigned = assignments[p.id] || [];

        if (assigned.length === 0) {
          const no = document.createElement("div");
          no.className = "no-assign";
          no.textContent = "Aucun employé disponible/compatible pour ce projet.";
          list.appendChild(no);
        } else {
          for (const { emp, s, isFixed } of assigned) {
            const card = document.createElement("div");
            card.className = "assignment-card" + (isFixed ? ' fixed-assignment' : '');

            const finalScorePercentage = (s.finalScore * 100).toFixed(1);

            const top = document.createElement("div");
            top.className = "assignment-top";
            top.innerHTML = `
              <span class="name">${emp.nom} ${isFixed ? '⭐ (Direct.)' : ''}</span>
              <div class="score-label">Score : ${finalScorePercentage}%</div>
            `;
            
            const scoreBar = document.createElement('div');
            scoreBar.className = 'score-bar-container';
            scoreBar.innerHTML = `<div class="score-bar" style="width: ${finalScorePercentage}%;"></div>`;

            const pills = document.createElement("div");
            pills.className = "pill-row";
            pills.innerHTML = `
              <span>${emp.metier || 'N/A'}</span>
              <span>Éval : ${(emp.evaluation || 0).toFixed(1)}/5</span>
              <span>Dist : ${emp.distanceKm || 'N/A'} km</span>
              <span>Affect. tot. : ${employeeLoad[emp.id] || 1}</span>
              <span>Dispo : ${emp.disponibilite || 'N/A'}</span>
            `;

            const detail = document.createElement("div");
            detail.className = "assignment-detail";
            detail.innerHTML = `
              Compétences : ${(emp.competences || []).join(", ")}<br/>
              Match requis : <strong>${(s.matched || 0)}/${(p.competencesRequises || []).length}</strong> (Compétences : ${(p.competencesRequises || []).join(", ")})<br/>
              Détail du score pondéré :
              <ul>
                <li>Compétences (50%) : ${(s.competenceScore * 50).toFixed(1)} / 50</li>
                <li>Évaluation (30%) : ${(s.evalScore * 30).toFixed(1)} / 30</li>
                <li>Distance (20%) : ${(s.distanceScore * 20).toFixed(1)} / 20</li>
                <li>Facteur de charge : ${(s.loadFactor * 100).toFixed(0)}%</li>
              </ul>
            `;

            card.appendChild(top);
            card.appendChild(scoreBar);
            card.appendChild(pills);
            card.appendChild(detail);
            list.appendChild(card);
          }
        }

        block.appendChild(list);
        assignmentsContainer.appendChild(block);
      }
      
      renderFixedList();
    }

    function initFixedSelectors() {
      if (!employees.length || !projects.length) {
        fixedProjectSelect.innerHTML = '<option>Aucune donnée chargée</option>';
        fixedEmployeeSelect.innerHTML = '<option>Aucune donnée chargée</option>';
        return;
      }

      fixedProjectSelect.innerHTML = '';
      fixedEmployeeSelect.innerHTML = '';

      projects.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = `${p.id} – ${p.nom}`;
        fixedProjectSelect.appendChild(opt);
      });

      employees.forEach(e => {
        const opt = document.createElement("option");
        opt.value = e.id;
        opt.textContent = `${e.nom} (${e.metier || 'N/A'} - ${e.id} | Dispo: ${e.disponibilite || 'N/A'})`;
        fixedEmployeeSelect.appendChild(opt);
      });
    }

    // ===========================================
    // ÉVÉNEMENTS
    // ===========================================
    
    // Événements de planification
    planAllBtn.addEventListener("click", () => {
      const result = planAllProjectsGlobally();
      if (result) renderAssignments(result);
    });

    // Événements de gestion des données
    loadDataBtn.addEventListener("click", loadDataFromUI);
    saveDataBtn.addEventListener("click", saveDataToLocalStorage);
    resetDataBtn.addEventListener("click", resetDataToDefault);
    
    // Événements de gestion de projet (Formulaire)
    saveProjectBtn.addEventListener('click', saveProject);
    cancelEditBtn.addEventListener('click', (e) => {
        e.preventDefault();
        resetProjectForm();
    });

    // Ajouter une directive fixe
    document.getElementById("addFixedBtn").addEventListener("click", () => {
      const projectId = fixedProjectSelect.value;
      const empId = fixedEmployeeSelect.value;
      if (!projectId || !empId) return;

      const exists = fixedAssignments.some(
        d => d.projectId === projectId && d.empId === empId
      );
      if (!exists) {
        fixedAssignments.push({ projectId, empId, status: 'pending', reason: null }); 
        renderFixedList();
      }
    });

    // Effacer toutes les directives
    document.getElementById("clearFixedBtn").addEventListener("click", () => {
      fixedAssignments = [];
      renderFixedList();
      summaryText.textContent = "Toutes les directives ont été effacées. Cliquez sur 'Générer une nouvelle planification (IA)' pour mettre à jour les affectations.";
    });

    // Initialisation au chargement
    document.addEventListener('DOMContentLoaded', initializeData);
  </script>
</body>
</html>