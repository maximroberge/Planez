<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Planif IA – Gestion des Projets et Affectation (v6.1)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Styles CSS (revus pour la clarté du résultat) */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      padding: 24px;
    }
    .app {
      max-width: 1600px;
      margin: 0 auto;
    }
    header { margin-bottom: 24px; }
    header h1 { font-size: 1.8rem; margin-bottom: 6px; }
    header p { font-size: 0.95rem; color: #9ca3af; }
    .tagline { font-size: 0.8rem; color: #64748b; margin-top: 4px; }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1.8fr; /* 3 colonnes conservées */
      gap: 24px;
      align-items: flex-start;
    }
    .card {
      background: #020617;
      border-radius: 16px;
      padding: 20px;
      border: 1px solid #1f2937;
      box-shadow: 0 18px 40px rgba(0,0,0,0.5);
      min-height: 400px;
    }
    .card h2 { font-size: 1.15rem; margin-bottom: 8px; }
    .card small { color: #6b7280; font-size: 0.75rem; }
    label { display: block; font-size: 0.8rem; margin-bottom: 4px; color: #9ca3af; }
    select, input:not([type="checkbox"]), textarea {
      width: 100%;
      padding: 6px 8px;
      margin-bottom: 8px;
      border-radius: 10px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.85rem;
      resize: vertical;
    }
    input[type="date"] { padding: 5px 8px; }

    select:focus, input:focus, textarea:focus { outline: 2px solid #38bdf8; border-color: #38bdf8; }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.85rem;
      cursor: pointer;
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: white;
      font-weight: 500;
      margin-top: 6px;
      transition: all 0.2s;
    }
    button:hover { opacity: 0.95; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(56, 189, 248, 0.3); }
    .btn-secondary {
      background: #111827;
      border: 1px solid #374151;
      margin-left: 6px;
      color: #e5e7eb;
    }
    .btn-secondary:hover { box-shadow: none; border-color: #4b5563; transform: translateY(0); }
    
    /* Colonnes de listes */
    .projects-list, .fixed-list {
      max-height: 250px;
      overflow-y: auto;
      padding-right: 10px;
      font-size: 0.8rem;
    }
    .projects-list::-webkit-scrollbar, .fixed-list::-webkit-scrollbar { width: 6px; }
    .projects-list::-webkit-scrollbar-thumb, .fixed-list::-webkit-scrollbar-thumb { background: #374151; border-radius: 3px; }

    /* Project Management List & Needs List */
    .project-management-list, #projectNeedsList {
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        max-height: 200px; /* Reduced for Needs list space */
        overflow-y: auto;
        padding-right: 5px;
        font-size: 0.8rem;
    }
    .project-management-item, .need-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 10px;
        background: #0f172a;
        border-radius: 8px;
        border: 1px solid #1e293b;
    }
    .project-management-item-details, .need-item-details { flex-grow: 1; margin-right: 10px; }
    .project-management-item strong { font-size: 0.9rem; display: block; }
    .project-management-item small { color: #9ca3af; }
    .project-management-actions button, .need-actions button { margin: 0 0 0 4px; padding: 4px 8px; font-size: 0.75rem; }
    
    /* Styles de Résultat (Result Display Styles - Flat List) */
    .project-block { 
        border-top: 1px solid #1f2937; 
        padding-top: 10px; 
        margin-top: 10px; 
    }
    .project-block-title h3 { font-size: 1.1rem; margin-bottom: 4px; }
    .project-block-title span { font-size: 0.8rem; color: #9ca3af; }
    .assignment-list-flat {
        margin-top: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .assignment-card {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #374151;
        background: #0f172a;
        font-size: 0.8rem;
    }
    .assignment-card.fixed-assignment {
        border-left: 4px solid #fde047;
    }
    .assignment-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
    }
    .assignment-top .name {
        font-weight: 600;
        font-size: 0.9rem;
        color: #e5e7eb;
    }
    .score-label {
        font-size: 0.85rem;
        color: #38bdf8;
        font-weight: 500;
    }
    .score-bar-container {
        height: 6px;
        background: #1f2937;
        border-radius: 3px;
        margin-bottom: 8px;
    }
    .score-bar {
        height: 100%;
        background: linear-gradient(90deg, #6366f1, #38bdf8);
        border-radius: 3px;
    }
    .pill-row {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
        flex-wrap: wrap;
    }
    .pill-row span {
        background: #111827;
        padding: 3px 6px;
        border-radius: 4px;
        font-size: 0.75rem;
        color: #9ca3af;
    }
    .assignment-detail {
        margin-top: 8px;
        padding: 8px;
        border-top: 1px dashed #1f2937;
        font-size: 0.75rem;
        line-height: 1.4;
    }
    .assignment-detail ul {
        padding-left: 20px;
        margin-top: 4px;
    }
    .assignment-detail li {
        margin-bottom: 2px;
        color: #9ca3af;
    }
    .no-assign {
        color: #9ca3af;
        font-style: italic;
        padding: 5px;
    }
    
    .data-status { margin-top: 8px; padding: 8px; border-radius: 6px; font-size: 0.8rem; }
    .data-status.success { background: #166534; color: #dcfce7; }
    .data-status.error { background: #991b1b; color: #fee2e2; }
    .data-area textarea { height: 200px; font-family: monospace; font-size: 0.75rem; }

    @media (max-width: 1400px) {
      .grid { grid-template-columns: 1fr 1fr; }
      .grid > section:last-child { grid-column: 1 / span 2; }
    }
    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
      .grid > section:last-child { grid-column: 1 / span 1; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Planificateur IA – Affectation globale (v6.1)</h1>
      <p>
        **Nouveau: Gestion avancée des projets** avec plusieurs corps de métier, dates et slots différents par besoin.
      </p>
      <div class="tagline">
        Priorité : **Disponibilité** > Compétences > Évaluation > Distance.
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <h2>1. Planification & Directives</h2>
        <small id="databaseSummary">Base de données : N/A</small>
        
        <div style="margin-top:10px; margin-bottom:4px;">
          <button id="planAllBtn">Générer une nouvelle planification (IA)</button>
        </div>
        <small style="display:block;margin-top:2px;color:#6b7280;font-size:0.75rem;">
          L'IA utilisera les données chargées.
        </small>

        <div style="margin-top:16px; border-top:1px solid #1f2937; padding-top:12px;">
          <h3 style="font-size:0.95rem;margin-bottom:4px;">Directive fixe (Manuelle)</h3>

          <label style="margin-top:8px;">Projet</label>
          <select id="fixedProjectSelect"></select>

          <label>Employé</label>
          <select id="fixedEmployeeSelect"></select>

          <button id="addFixedBtn">Ajouter la directive</button>
          <button id="clearFixedBtn" class="btn-secondary">Effacer toutes les directives</button>

          <div class="fixed-list" id="fixedList">
            Aucune directive pour l’instant.
          </div>
        </div>
        
        <div style="margin-top:24px; border-top:1px solid #1f2937; padding-top:12px;">
            <h3 style="font-size:0.95rem;">Projets chargés (Aperçu)</h3>
        </div>
        <div class="projects-list" id="projectsList"></div>
      </section>

      <section class="card data-management">
        <h2>2. Gestion de la Base de Données</h2>
        
        <div class="data-controls">
            <button id="loadDataBtn">Mettre à jour la base de données</button>
            <button id="saveDataBtn" class="btn-secondary">Sauvegarder (Localement)</button>
            <button id="resetDataBtn" class="btn-secondary">Réinitialiser (Données par défaut)</button>
        </div>
        <div id="dataStatus" class="data-status">Prêt.</div>
        
        <h3 style="font-size:1.15rem; margin-top:20px; color: #38bdf8;">2.5 Gestion Manuelle</h3>

        <div style="margin-top:16px; border-top:1px solid #1f2937; padding-top:12px;">
            <h3 style="font-size:1rem; margin-bottom:10px;">Projet (ID & Nom) <small style="color:#fde047; margin-left:10px;" id="currentProjectEditStatus">Nouveau Projet</small></h3>
            
            <label for="projectIdInput">ID Projet (P-XXX)</label>
            <input type="text" id="projectIdInput" placeholder="Ex: P-999" required />

            <label for="projectNomInput">Nom du Projet</label>
            <input type="text" id="projectNomInput" placeholder="Ex: Arrêt usine X" required />
            
            <div style="display:flex; justify-content: flex-end; margin-top: 5px;">
                <button id="saveProjectHeaderBtn">Créer / Mettre à jour le projet</button>
                <button id="cancelEditBtn" class="btn-secondary" style="display:none;">Annuler l'édition</button>
            </div>
        </div>
        
        <div id="needsManagementSection" style="margin-top:20px; border-top:1px solid #1f2937; padding-top:12px; display:none;">
            <h3 style="font-size:1rem; margin-bottom:10px;">Besoins Spécifiques (Métier, Durée, Slots)</h3>
            <small id="currentProjectNeedsName" style="display:block; margin-bottom: 8px; color: #4ade80;"></small>
            
            <input type="hidden" id="currentNeedId" value="0" />
            
            <label for="needMetierSelect">Métier Requis</label>
            <select id="needMetierSelect">
                <option value="mecanicien">mecanicien</option>
                <option value="soudeur">soudeur</option>
                <option value="tuyauteur">tuyauteur</option>
                <option value="manoeuvre">manoeuvre</option>
            </select>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div>
                    <label for="needDebutInput">Date de Début</label>
                    <input type="date" id="needDebutInput" required />
                </div>
                <div>
                    <label for="needFinInput">Date de Fin</label>
                    <input type="date" id="needFinInput" required />
                </div>
            </div>
            
            <label for="needSlotsInput">Nombre de Postes (Slots)</label>
            <input type="number" id="needSlotsInput" min="1" max="10" value="1" required />

            <label for="needCompetencesInput">Compétences Requises (séparées par une virgule)</label>
            <input type="text" id="needCompetencesInput" placeholder="Ex: MIG, Lecture plan" required />

            <div style="display:flex; justify-content: flex-end; margin-top: 5px;">
                <button id="saveNeedBtn">Ajouter ce besoin</button>
                <button id="cancelNeedEditBtn" class="btn-secondary" style="display:none;">Annuler l'édition</button>
            </div>
            
            <div style="margin-top:15px; border-top:1px dashed #1f2937; padding-top:10px;">
                <h4 style="font-size:0.9rem; margin-bottom:5px; color:#94a3b8;">Besoins Actuels du Projet (<span id="totalNeedsSlots">0</span> slots totaux)</h4>
                <div id="projectNeedsList"></div>
            </div>
        </div>
        
        <div style="margin-top:20px; border-top:1px solid #1f2937; padding-top:12px;">
            <h3 style="font-size:1rem;">Projets Actuellement dans la Base</h3>
            <div class="project-management-list" id="projectManagementList"></div>
        </div>
        
        <div class="data-area" style="margin-top:20px; border-top:1px solid #1f2937; padding-top:12px;">
            <label for="employeesJSON">Employés (JSON Array - Volume élevé : 150 employés) <small style="color:#fde047;">Modifier ici la 'disponibilite' ou l'évaluation.</small></label>
            <textarea id="employeesJSON"></textarea>
        </div>
      </section>

      <section class="card">
        <div class="result-header">
          <div>
            <h2>3. Résultat de la planification</h2>
            <small id="summaryText">Cliquez sur “Générer une nouvelle planification (IA)” pour commencer.</small>
          </div>
        </div>
        <div id="assignmentsContainer"></div>
      </section>
    </div>
  </div>

  <script>
    
    // ==========================================================
    // GÉNÉRATION DE DONNÉES PAR DÉFAUT
    // ==========================================================

    const allSkills = {
        mecanicien: ["Alignement", "Hydraulique", "Maintenance préventive", "Maintenance corrective", "Réducteur", "Pneumatique", "Usinage", "Montage de convoyeur", "Analyse vibration"],
        soudeur: ["MIG", "TIG", "ARC", "TIG inox", "Soudure inox", "Lecture plan", "Pont roulant", "Espaces clos", "ASP"],
        tuyauteur: ["Filetage", "Raccordement de vannes", "Lecture isométriques", "ASME B31.3", "Assemblage tuyauterie haute pression", "Soudure orbitale", "Test d'étanchéité"],
        manoeuvre: ["Manutention", "Nettoyage industriel", "Élingage de base", "Travail en hauteur", "Espaces clos", "Permis cariste", "Sécurité SIMDUT"]
    };

    const names = ["Alexandre", "Marie", "Charles", "Sophie", "David", "Julie", "Gabriel", "Audrey", "Louis", "Nadia", "Thomas", "Isabelle", "Nicolas", "Rachel", "Philippe", "Cynthia"];
    const surnames = ["Tremblay", "Gagnon", "Côté", "Bouchard", "Gauthier", "Dion", "Proulx", "Richard", "Girard", "Lapointe"];
    
    function getRandomElement(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
    }

    function getRandomSkills(metier, min, max) {
        const availableSkills = allSkills[metier];
        const count = Math.floor(Math.random() * (max - min + 1)) + min;
        const shuffled = availableSkills.sort(() => 0.5 - Math.random());
        return shuffled.slice(0, count);
    }
    
    function generateEmployees(metier, count, prefix) {
        const employees = [];
        const uniqueNames = new Set();
        const disponibilites = ["Disponible", "Disponible", "Disponible", "Sur chantier", "En congé"];

        for (let i = 1; i <= count; i++) {
            let nom;
            do {
                nom = `${getRandomElement(names)} ${getRandomElement(surnames)}`;
            } while (uniqueNames.has(nom));
            uniqueNames.add(nom);

            const id = `${prefix}-${String(i).padStart(3, '0')}`;
            const evaluation = parseFloat((Math.random() * (5.0 - 3.5) + 3.5).toFixed(1)); 
            const distanceKm = Math.floor(Math.random() * 45) + 5; 
            const competenceRange = metier === 'manoeuvre' ? { min: 2, max: 4 } : { min: 3, max: 5 };

            employees.push({
                id,
                nom,
                metier,
                competences: getRandomSkills(metier, competenceRange.min, competenceRange.max),
                disponibilite: getRandomElement(disponibilites), 
                distanceKm,
                evaluation
            });
        }
        return employees;
    }

    const initialEmployees = [
      ...generateEmployees('mecanicien', 40, 'M'),
      ...generateEmployees('soudeur', 40, 'S'),
      ...generateEmployees('tuyauteur', 35, 'T'),
      ...generateEmployees('manoeuvre', 35, 'N')
    ];
    initialEmployees.sort((a, b) => a.nom.localeCompare(b.nom));

    // NOUVELLE STRUCTURE DE PROJET: Liste de Besoins (Needs)
    const initialProjects = [
      { id:"P-101", nom:"Arrêt chaudière – Bécancour", needs:[
        { needId:1, metier:"soudeur", competencesRequises:["MIG","Espaces clos","ASP"], debut:"2026-01-10", fin:"2026-01-18", slots:4 },
        { needId:2, metier:"manoeuvre", competencesRequises:["Nettoyage industriel","Sécurité SIMDUT"], debut:"2026-01-15", fin:"2026-01-19", slots:2 }
      ]},
      { id:"P-102", nom:"Remplacement convoyeur – Trois-Rivières", needs:[
        { needId:1, metier:"mecanicien", competencesRequises:["Maintenance préventive","Alignement","Hydraulique"], debut:"2026-01-12", fin:"2026-01-25", slots:5 },
        { needId:2, metier:"soudeur", competencesRequises:["ARC"], debut:"2026-01-18", fin:"2026-01-20", slots:1 }
      ]},
      { id:"P-103", nom:"Ligne vapeur HP – Shawinigan", needs:[
        { needId:1, metier:"tuyauteur", competencesRequises:["Lecture isométriques","ASME B31.3"], debut:"2026-01-20", fin:"2026-02-02", slots:3 },
        { needId:2, metier:"manoeuvre", competencesRequises:["Manutention"], debut:"2026-01-25", fin:"2026-01-30", slots:1 }
      ]},
      { id:"P-104", nom:"Nettoyage silo – Bécancour", needs:[
        { needId:1, metier:"manoeuvre", competencesRequises:["Nettoyage industriel","Espaces clos"], debut:"2026-01-15", fin:"2026-01-19", slots:4 }
      ]},
      { id:"P-105", nom:"Projet inox – Québec", needs:[
        { needId:1, metier:"soudeur", competencesRequises:["TIG inox","Soudure inox","Lecture plan"], debut:"2026-02-01", fin:"2026-02-15", slots:5 }
      ]},
      { id:"P-106", nom:"Maintenance usine – Laval", needs:[
        { needId:1, metier:"mecanicien", competencesRequises:["Maintenance corrective","Pneumatique","Réducteur"], debut:"2026-01-28", fin:"2026-02-10", slots:3 }
      ]},
      { id:"P-107", nom:"Installation pompe – Sherbrooke", needs:[
        { needId:1, metier:"mecanicien", competencesRequises:["Hydraulique","Analyse vibration"], debut:"2026-02-05", fin:"2026-02-12", slots:2 }
      ]},
      { id:"P-108", nom:"Rénovation tuyauterie – Lévis", needs:[
        { needId:1, metier:"tuyauteur", competencesRequises:["Filetage","Raccordement de vannes","Test d'étanchéité"], debut:"2026-02-10", fin:"2026-02-28", slots:5 }
      ]},
    ];
    
    // Variables globales
    let employees = [];
    let projects = [];
    let fixedAssignments = [];
    let projectBeingEdited = null; // Stores the whole project object for editing its needs
    let needBeingEditedId = null; // Stores the needId for the need being edited

    // ===========================================
    // SÉLECTEURS D'ÉLÉMENTS UI
    // ===========================================
    const projectsListEl = document.getElementById("projectsList");
    const assignmentsContainer = document.getElementById("assignmentsContainer");
    const summaryText = document.getElementById("summaryText");
    const planAllBtn = document.getElementById("planAllBtn");
    const loadDataBtn = document.getElementById("loadDataBtn");
    const saveDataBtn = document.getElementById("saveDataBtn");
    const resetDataBtn = document.getElementById("resetDataBtn");
    const dataStatus = document.getElementById("dataStatus");
    const databaseSummary = document.getElementById("databaseSummary");
    const employeesJSONArea = document.getElementById("employeesJSON");
    const fixedProjectSelect = document.getElementById("fixedProjectSelect");
    const fixedEmployeeSelect = document.getElementById("fixedEmployeeSelect");
    const fixedList = document.getElementById("fixedList");

    // Sélecteurs de formulaire Projet Général
    const projectIdInput = document.getElementById('projectIdInput');
    const projectNomInput = document.getElementById('projectNomInput');
    const saveProjectHeaderBtn = document.getElementById('saveProjectHeaderBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const projectManagementList = document.getElementById('projectManagementList');
    const currentProjectEditStatus = document.getElementById('currentProjectEditStatus');
    const needsManagementSection = document.getElementById('needsManagementSection');

    // Sélecteurs de formulaire Besoin (Need)
    const currentNeedId = document.getElementById('currentNeedId');
    const needMetierSelect = document.getElementById('needMetierSelect');
    const needDebutInput = document.getElementById('needDebutInput');
    const needFinInput = document.getElementById('needFinInput');
    const needSlotsInput = document.getElementById('needSlotsInput');
    const needCompetencesInput = document.getElementById('needCompetencesInput');
    const saveNeedBtn = document.getElementById('saveNeedBtn');
    const cancelNeedEditBtn = document.getElementById('cancelNeedEditBtn');
    const projectNeedsList = document.getElementById('projectNeedsList');
    const currentProjectNeedsName = document.getElementById('currentProjectNeedsName');
    const totalNeedsSlots = document.getElementById('totalNeedsSlots');


    // ===========================================
    // LOGIQUE DE GESTION DES DONNÉES ET INITIALISATION
    // ===========================================

    function setStatus(message, isError = false) {
        dataStatus.textContent = message;
        dataStatus.className = "data-status " + (isError ? "error" : "success");
    }
    
    // Helper pour obtenir la plus grande ID de besoin pour un projet
    function getNextNeedId(proj) {
        if (!proj.needs || proj.needs.length === 0) return 1;
        return Math.max(...proj.needs.map(n => n.needId)) + 1;
    }

    function loadEmployeesFromUI() {
        try {
            const loadedEmployees = JSON.parse(employeesJSONArea.value);
            if (!Array.isArray(loadedEmployees) || loadedEmployees.length === 0) {
                throw new Error("La liste des employés est vide ou n'est pas un tableau valide.");
            }
            employees = loadedEmployees.sort((a, b) => a.nom.localeCompare(b.nom));
            return true;
        } catch (e) {
            setStatus("Erreur JSON des employés : " + e.message, true);
            return false;
        }
    }

    function loadDataFromUI(showStatus = true) {
        if (!loadEmployeesFromUI()) return false;
        
        renderProjectsList();
        renderProjectManagementList();
        initFixedSelectors();
        
        const totalSlots = projects.reduce((sum, p) => sum + p.needs.reduce((nSum, n) => nSum + n.slots, 0), 0);
        
        databaseSummary.textContent = `Base de données : ${employees.length} employés / ${projects.length} projets (${totalSlots} slots totaux).`;
        if (showStatus) {
            setStatus("Données chargées avec succès. Prêt pour la planification.");
        }
        return true;
    }

    function displayCurrentData(empData, projData) {
        employeesJSONArea.value = JSON.stringify(empData, null, 2);
        projects = projData; 
    }

    function initializeData() {
        const storedEmployees = localStorage.getItem('planif_employees');
        const storedProjects = localStorage.getItem('planif_projects');

        if (storedEmployees && storedProjects) {
            try {
                displayCurrentData(JSON.parse(storedEmployees), JSON.parse(storedProjects));
                loadDataFromUI(false);
            } catch (e) {
                displayCurrentData(initialEmployees, initialProjects);
                loadDataFromUI(false);
                setStatus("Sauvegarde locale corrompue. Chargement des données par défaut.");
            }
        } else {
            displayCurrentData(initialEmployees, initialProjects);
            loadDataFromUI(false);
        }
        
        resetProjectForm(); 
    }

    function saveDataToLocalStorage() {
        localStorage.setItem('planif_employees', employeesJSONArea.value);
        localStorage.setItem('planif_projects', JSON.stringify(projects, null, 2));
        setStatus("Données sauvegardées dans le stockage local du navigateur.", false);
    }
    
    function resetDataToDefault() {
        localStorage.removeItem('planif_employees');
        localStorage.removeItem('planif_projects');
        fixedAssignments = [];
        displayCurrentData(initialEmployees, initialProjects);
        loadDataFromUI();
        renderFixedList();
        setStatus("Données réinitialisées aux valeurs par défaut.", false);
    }
    
    // ===========================================
    // LOGIQUE DE GESTION DES PROJETS (HEADER ET NEEDS)
    // ===========================================
    
    function resetNeedForm() {
        needBeingEditedId = null;
        currentNeedId.value = 0;
        needMetierSelect.value = 'mecanicien';
        needDebutInput.value = new Date().toISOString().substring(0, 10);
        needFinInput.value = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().substring(0, 10);
        needSlotsInput.value = 1;
        needCompetencesInput.value = '';
        saveNeedBtn.textContent = 'Ajouter ce besoin';
        cancelNeedEditBtn.style.display = 'none';
    }
    
    function resetProjectForm() {
        projectBeingEdited = null;
        let nextIdNumber = projects.length + 1;
        while(projects.some(p => p.id === 'P-' + String(nextIdNumber).padStart(3, '0'))) {
             nextIdNumber++;
        }
        projectIdInput.value = 'P-' + String(nextIdNumber).padStart(3, '0');
        projectNomInput.value = '';
        currentProjectEditStatus.textContent = 'Nouveau Projet';
        saveProjectHeaderBtn.textContent = 'Créer le nouveau projet';
        cancelEditBtn.style.display = 'none';
        projectIdInput.disabled = false;
        needsManagementSection.style.display = 'none';
        resetNeedForm();
    }
    
    function renderNeedsList(proj) {
        projectNeedsList.innerHTML = '';
        if (!proj.needs || proj.needs.length === 0) {
            projectNeedsList.innerHTML = '<p style="color:#9ca3af; font-style:italic;">Aucun besoin défini pour ce projet.</p>';
            totalNeedsSlots.textContent = 0;
            return;
        }
        
        let totalSlotsCount = 0;

        proj.needs.forEach(n => {
            totalSlotsCount += n.slots;
            const div = document.createElement('div');
            div.className = 'need-item';
            div.innerHTML = `
                <div class="need-item-details">
                    <strong>${n.metier.toUpperCase()} (${n.slots} postes)</strong>
                    <small>${n.debut} → ${n.fin} | Comp: ${n.competencesRequises.join(', ') || 'Aucune'}</small>
                </div>
                <div class="need-actions">
                    <button class="edit-need-btn btn-secondary" data-id="${n.needId}">Éditer</button>
                    <button class="delete-need-btn" data-id="${n.needId}">Supprimer</button>
                </div>
            `;
            projectNeedsList.appendChild(div);
        });
        
        totalNeedsSlots.textContent = totalSlotsCount;
        
        projectNeedsList.querySelectorAll('.edit-need-btn').forEach(btn => {
            btn.addEventListener('click', (e) => editNeed(parseInt(e.target.dataset.id)));
        });
        projectNeedsList.querySelectorAll('.delete-need-btn').forEach(btn => {
            btn.addEventListener('click', (e) => deleteNeed(parseInt(e.target.dataset.id)));
        });
    }

    function saveProjectHeader() {
        const id = projectIdInput.value.trim();
        const nom = projectNomInput.value.trim();
        
        if (!id || !nom) {
            setStatus("Veuillez remplir l'ID et le Nom du projet.", true);
            return;
        }

        let existingProjectIndex = projects.findIndex(p => p.id === id);
        
        if (existingProjectIndex !== -1) {
            // Update existing project header
            projects[existingProjectIndex].nom = nom;
            projectBeingEdited = projects[existingProjectIndex];
            setStatus(`Projet ${id} mis à jour. Passez à la gestion des besoins.`, false);
        } else {
            // Create new project
            if (projects.some(p => p.id === id)) {
                 setStatus(`Erreur: Un projet avec l'ID ${id} existe déjà.`, true);
                 return;
            }
            projectBeingEdited = { id, nom, needs: [] };
            projects.push(projectBeingEdited);
            setStatus(`Nouveau projet ${id} créé. Ajoutez les besoins ci-dessous.`, false);
        }
        
        // Setup UI for needs management
        projectIdInput.disabled = true; 
        currentProjectEditStatus.textContent = `Édition de ${id}`;
        saveProjectHeaderBtn.textContent = 'Mettre à jour le nom';
        cancelEditBtn.style.display = 'inline-block';
        needsManagementSection.style.display = 'block';
        currentProjectNeedsName.textContent = `Projet : ${nom} (${id})`;
        
        renderNeedsList(projectBeingEdited);
        resetNeedForm();
        loadDataFromUI(false); 
        document.getElementById('needsManagementSection').scrollIntoView({ behavior: 'smooth' });
    }
    
    function editProject(projectId) {
        projectBeingEdited = projects.find(p => p.id === projectId);
        if (!projectBeingEdited) return;
        
        projectIdInput.value = projectBeingEdited.id;
        projectNomInput.value = projectBeingEdited.nom;
        
        // Trigger the save header function to set up the UI for editing
        saveProjectHeader(); 
    }
    
    function deleteProject(projectId) {
        if (confirm(`Êtes-vous sûr de vouloir supprimer le projet ${projectId} et tous ses besoins?`)) {
            projects = projects.filter(p => p.id !== projectId);
            
            fixedAssignments = fixedAssignments.filter(d => d.projectId !== projectId);
            
            setStatus(`Projet ${projectId} supprimé.`, false);
            loadDataFromUI(false);
            renderFixedList();
            
            if(projectBeingEdited && projectBeingEdited.id === projectId) {
                resetProjectForm();
            }
        }
    }
    
    // --- Gestion des Besoins (Needs) ---

    function saveNeed() {
        if (!projectBeingEdited) {
            setStatus("Veuillez d'abord créer ou sélectionner un projet.", true);
            return;
        }
        
        const metier = needMetierSelect.value;
        const debut = needDebutInput.value;
        const fin = needFinInput.value;
        const slots = parseInt(needSlotsInput.value, 10);
        const competencesRequises = needCompetencesInput.value.split(',').map(c => c.trim()).filter(c => c.length > 0);
        const needId = parseInt(currentNeedId.value, 10);
        
        if (!metier || !debut || !fin || isNaN(slots) || slots < 1) {
            setStatus("Veuillez remplir tous les champs du besoin (Métier, Dates, Slots > 0).", true);
            return;
        }

        const newNeed = {
            metier,
            competencesRequises,
            debut,
            fin,
            slots
        };

        if (needBeingEditedId) {
            // Update existing need
            const index = projectBeingEdited.needs.findIndex(n => n.needId === needId);
            if (index !== -1) {
                projectBeingEdited.needs[index] = { ...newNeed, needId }; // Keep the original ID
                setStatus(`Besoin (${metier}) mis à jour pour ${projectBeingEdited.id}.`, false);
            } else {
                setStatus("Erreur: Besoin introuvable pour la mise à jour.", true);
            }
        } else {
            // Add new need
            const newId = getNextNeedId(projectBeingEdited);
            projectBeingEdited.needs.push({ ...newNeed, needId: newId });
            setStatus(`Nouveau besoin (${metier}) ajouté à ${projectBeingEdited.id}.`, false);
        }
        
        resetNeedForm();
        renderNeedsList(projectBeingEdited);
        loadDataFromUI(false); // Update all UI lists and selectors
    }
    
    function editNeed(needId) {
        const need = projectBeingEdited.needs.find(n => n.needId === needId);
        if (!need) return;
        
        needBeingEditedId = needId;
        currentNeedId.value = needId;
        needMetierSelect.value = need.metier;
        needDebutInput.value = need.debut;
        needFinInput.value = need.fin;
        needSlotsInput.value = need.slots;
        needCompetencesInput.value = need.competencesRequises.join(', ');
        
        saveNeedBtn.textContent = `Mettre à jour le besoin ID ${needId}`;
        cancelNeedEditBtn.style.display = 'inline-block';
        
        document.getElementById('needsManagementSection').scrollIntoView({ behavior: 'smooth' });
    }
    
    function deleteNeed(needId) {
        if (!projectBeingEdited) return;
        
        projectBeingEdited.needs = projectBeingEdited.needs.filter(n => n.needId !== needId);
        
        // Remove directives related to this specific need
        fixedAssignments = fixedAssignments.filter(d => !(d.projectId === projectBeingEdited.id && d.needId === needId));
        
        setStatus(`Besoin ID ${needId} supprimé du projet ${projectBeingEdited.id}.`, false);
        renderNeedsList(projectBeingEdited);
        renderFixedList();
        loadDataFromUI(false);
        resetNeedForm();
    }
    
    function renderProjectManagementList() {
        projectManagementList.innerHTML = '';
        if (projects.length === 0) {
            projectManagementList.innerHTML = '<p style="color:#9ca3af; font-style:italic;">Aucun projet dans la base de données.</p>';
            return;
        }
        
        const sorted = [...projects].sort((a, b) => a.id.localeCompare(b.id));

        sorted.forEach(p => {
            const totalNeeds = p.needs.length;
            const totalSlots = p.needs.reduce((sum, n) => sum + n.slots, 0);
            const metiers = [...new Set(p.needs.map(n => n.metier))].join(', ');
            
            const div = document.createElement('div');
            div.className = 'project-management-item';
            div.innerHTML = `
                <div class="project-management-item-details">
                    <strong>${p.id} – ${p.nom}</strong>
                    <small>${metiers} | ${totalNeeds} besoins | ${totalSlots} slots totaux</small>
                </div>
                <div class="project-management-actions">
                    <button class="edit-project-btn btn-secondary" data-id="${p.id}">Éditer</button>
                    <button class="delete-project-btn" data-id="${p.id}">Supprimer</button>
                </div>
            `;
            projectManagementList.appendChild(div);
        });
        
        projectManagementList.querySelectorAll('.edit-project-btn').forEach(btn => {
            btn.addEventListener('click', (e) => editProject(e.target.dataset.id));
        });
        projectManagementList.querySelectorAll('.delete-project-btn').forEach(btn => {
            btn.addEventListener('click', (e) => deleteProject(e.target.dataset.id));
        });
    }

    // ===========================================
    // LOGIQUE DE PLANIFICATION (MISE À JOUR)
    // ===========================================

    function parseDate(str) { return new Date(str + "T00:00:00"); }
    
    // Fonction révisée pour vérifier le chevauchement entre DEUX BESOINS
    function needsOverlap(n1, n2) {
      const s1 = parseDate(n1.debut);
      const e1 = parseDate(n1.fin);
      const s2 = parseDate(n2.debut);
      const e2 = parseDate(n2.fin);
      // Correction pour inclure les jours de fin (si fin est le 15, on peut commencer le 16)
      if (e1 < s2 || e2 < s1) return false;
      return true;
    }
    
    // Helper pour trouver un besoin par sa référence {projectId, needId}
    function getNeedByRef(ref) {
        const proj = projects.find(p => p.id === ref.projectId);
        if (proj) {
            return proj.needs.find(n => n.needId === ref.needId);
        }
        return null;
    }

    function shuffleArray(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }
    
    // Fonction révisée pour scorer un employé pour un BESOIN
    function scoreEmployeeForNeed(emp, need, employeeLoad) {
      if (!emp.disponibilite || !emp.disponibilite.toLowerCase().includes("disponible")) return null; 
      if (emp.metier !== need.metier) return null;
      
      const required = (need.competencesRequises || []).map(c => c.toLowerCase());
      const empSkills = (emp.competences || []).map(c => c.toLowerCase());
      const matched = required.filter(r => empSkills.includes(r)).length;
      
      if (required.length > 0 && matched === 0) return null; // Must match at least one if skills are required
      
      const competenceScore = required.length > 0 ? matched / required.length : 1; 
      const evalScore = Math.min(Math.max(emp.evaluation || 0, 0), 5) / 5;
      const maxDistance = 50;
      const distanceScore = Math.max(0, 1 - ((emp.distanceKm || maxDistance) / maxDistance));
      
      let baseScore = 0.5 * competenceScore + 0.3 * evalScore + 0.2 * distanceScore;
      const load = employeeLoad[emp.id] || 0;
      const loadFactor = 1 / (1 + load * 0.5); // Punition pour la charge de travail
      const finalScore = baseScore * loadFactor;
      
      return {
        finalScore, competenceScore, evalScore, distanceScore, matched, loadFactor
      };
    }

    function planAllProjectsGlobally() {
      if (!loadDataFromUI()) {
        assignmentsContainer.innerHTML = '<p style="color:#f97373;">Erreur de chargement des données. Veuillez corriger le JSON des employés ou vérifier la liste des projets.</p>';
        return;
      }
      if (projects.length === 0) {
        assignmentsContainer.innerHTML = '<p style="color:#f97373;">Veuillez ajouter des projets/besoins avant de lancer la planification.</p>';
        return;
      }

      assignmentsContainer.innerHTML = '<p style="color:#38bdf8;">Planification en cours...</p>';
      
      // Tri des besoins par date de début (pour prioriser les projets imminents)
      const allNeeds = projects.flatMap(p => 
        p.needs.map(n => ({ ...n, projectId: p.id, projectName: p.nom }))
      ).sort((a, b) => parseDate(a.debut) - parseDate(b.debut));

      // assignments: { "P-101": { 1: [assignments for need 1], 2: [...] } }
      const assignments = {};
      // employeeAssignments: { "M-001": [ {projectId: "P-101", needId: 1, debut: "...", fin: "..."}, ... ] }
      const employeeAssignments = {};
      const employeeLoad = {};

      projects.forEach(p => { assignments[p.id] = {}; });
      
      // Initialize employeeAssignments & load
      employees.forEach(e => { 
        employeeAssignments[e.id] = [];
        employeeLoad[e.id] = 0;
      });

      fixedAssignments = fixedAssignments.map(d => ({ ...d, status: 'pending', reason: null, conflitNeedRef: null }));
      
      // 1) Appliquer d'abord les directives fixes
      for (let i = 0; i < fixedAssignments.length; i++) {
        const directive = fixedAssignments[i];
        const emp = employees.find(e => e.id === directive.empId);

        if (!emp) continue;

        let status = 'failed';
        let reason = `Employé ${directive.empId} introuvable.`;
        let bestNeedForFixed = null;
        let proj = null;
        
        // Find the project and all compatible needs
        proj = projects.find(pr => pr.id === directive.projectId);
        if (!proj) { 
            reason = `Projet ${directive.projectId} introuvable.`;
            fixedAssignments[i].status = 'conflict_proj_not_found';
            fixedAssignments[i].reason = reason;
            continue;
        }

        if (!emp.disponibilite || !emp.disponibilite.toLowerCase().includes("disponible")) {
            reason = `Employé non disponible (${emp.disponibilite || 'N/A'})`;
            fixedAssignments[i].status = 'conflict_dispo';
            fixedAssignments[i].reason = reason;
            continue;
        }

        const candidatesNeeds = proj.needs.filter(n => n.metier === emp.metier);

        if (candidatesNeeds.length === 0) {
            reason = `Aucun besoin de ${emp.metier} dans ce projet.`;
            fixedAssignments[i].status = 'conflict_metier';
            fixedAssignments[i].reason = reason;
            continue;
        }
        
        // Find the best available need (priority: no overlap, has slots)
        for (const need of candidatesNeeds) {
            if (!assignments[proj.id][need.needId]) { assignments[proj.id][need.needId] = []; }

            if (assignments[proj.id][need.needId].length < need.slots) {
                
                // Check for overlap with existing assignments (needs) for this employee
                let overlap = false;
                for (const assignedNeedRef of employeeAssignments[emp.id]) {
                    const assignedNeed = getNeedByRef(assignedNeedRef);
                    if (assignedNeed && needsOverlap(assignedNeed, need)) { 
                        overlap = true;
                        fixedAssignments[i].conflitNeedRef = assignedNeedRef;
                        reason = `Chevauchement avec ${assignedNeed.metier} de ${assignedNeedRef.projectId}`;
                        fixedAssignments[i].status = 'conflict_overlap';
                        break;
                    }
                }
                if (!overlap) {
                    bestNeedForFixed = need;
                    break; 
                }
            } else {
                reason = `Slots complets pour le besoin ${need.needId} (${need.metier}).`;
                fixedAssignments[i].status = 'conflict_slots';
            }
        }

        if (bestNeedForFixed) {
            status = 'assigned';
            const score = scoreEmployeeForNeed(emp, bestNeedForFixed, employeeLoad) || {
                finalScore: 1.0, competenceScore: 1.0, evalScore: (emp.evaluation || 0) / 5, 
                distanceScore: Math.max(0, 1 - ((emp.distanceKm || 50) / 50)), matched: (bestNeedForFixed.competencesRequises || []).length, loadFactor: 1 
            };
            
            assignments[proj.id][bestNeedForFixed.needId].push({ emp, s: score, isFixed: true });

            employeeAssignments[emp.id].push({ projectId: proj.id, needId: bestNeedForFixed.needId });
            employeeLoad[emp.id] = (employeeLoad[emp.id] || 0) + 1;
        }

        if (fixedAssignments[i].status === 'pending') { // Only update if still pending
            fixedAssignments[i].status = status;
            fixedAssignments[i].reason = reason;
        }
        
        fixedAssignments[i].employeeName = emp.nom;
        fixedAssignments[i].projectName = proj.nom;
      }

      // 2) Compléter les slots restants avec IA + shuffle
      for (const need of allNeeds) {
        const { projectId, needId, slots } = need;
        const shuffledEmployees = shuffleArray(employees);

        // Ensure the assignment array is initialized (for needs that didn't get fixed assignments)
        if (!assignments[projectId][needId]) { assignments[projectId][needId] = []; }

        for (let slot = assignments[projectId][needId].length; slot < slots; slot++) {
          const candidates = [];

          for (const emp of shuffledEmployees) {
            const alreadyAssignedHere = assignments[projectId][needId].some(a => a.emp.id === emp.id);
            if (alreadyAssignedHere) continue;

            const assignedNeedsRefs = employeeAssignments[emp.id] || [];
            let conflit = false;
            
            for (const assignedNeedRef of assignedNeedsRefs) {
                const assignedNeed = getNeedByRef(assignedNeedRef);
                if (assignedNeed && needsOverlap(assignedNeed, need)) { 
                    conflit = true;
                    break;
                }
            }
            if (conflit) continue;

            const s = scoreEmployeeForNeed(emp, need, employeeLoad);
            if (s) { candidates.push({ emp, s, isFixed: false }); }
          }

          if (candidates.length === 0) continue;

          candidates.sort((a, b) => b.s.finalScore - a.s.finalScore);
          const chosen = candidates[0];

          assignments[projectId][needId].push(chosen);
          employeeAssignments[chosen.emp.id].push({ projectId, needId });
          employeeLoad[chosen.emp.id] = (employeeLoad[chosen.emp.id] || 0) + 1;
        }
      }

      return { assignments, employeeAssignments, employeeLoad };
    }

    // ===========================================
    // RENDU UI (RÉVISÉ POUR LISTE PLATTE)
    // ===========================================
    
    function renderProjectsList() {
      projectsListEl.innerHTML = "";
      // Calculate max end date for sorting
      const projectsWithDates = projects.map(p => {
          let startDate = null;
          let endDate = null;
          if (p.needs && p.needs.length > 0) {
              startDate = p.needs.reduce((min, n) => (min === null || parseDate(n.debut) < min) ? parseDate(n.debut) : min, null);
              endDate = p.needs.reduce((max, n) => (max === null || parseDate(n.fin) > max) ? parseDate(n.fin) : max, null);
          }
          return { ...p, sortDate: startDate, displayStart: startDate ? startDate.toISOString().substring(0, 10) : 'N/A', displayEnd: endDate ? endDate.toISOString().substring(0, 10) : 'N/A' };
      });
      
      const sorted = projectsWithDates.sort((a, b) => a.sortDate - b.sortDate);
      
      for (const p of sorted) {
        const totalSlots = p.needs.reduce((sum, n) => sum + n.slots, 0);
        const metiers = [...new Set(p.needs.map(n => n.metier))].join(', ');
        
        const div = document.createElement("div");
        div.className = "project-line";
        div.innerHTML = `
          <strong>${p.id} – ${p.nom}</strong>
          <div class="project-meta">
            <span>Métiers : ${metiers}</span>
            <span>Slots Totaux : ${totalSlots}</span><br/>
            <span>Période Globale : ${p.displayStart} → ${p.displayEnd}</span>
          </div>
        `;
        projectsListEl.appendChild(div);
      }
    }

    function renderFixedList() {
      if (!fixedAssignments.length) {
        fixedList.textContent = "Aucune directive pour l’instant.";
        return;
      }
      fixedList.innerHTML = "";
      
      fixedAssignments.forEach((d, index) => { 
        const proj = projects.find(pr => pr.id === d.projectId);
        const emp = employees.find(e => e.id === d.empId);
        if (!proj || !emp) return;
        
        const div = document.createElement("div");
        div.className = "fixed-item";
        
        let statusText = '';
        let solutionText = '';
        
        let needInfo = '';
        const assignedNeed = getNeedByRef({ projectId: d.projectId, needId: d.needId });
        if (assignedNeed) {
            needInfo = ` (Besoin: ${assignedNeed.metier} ${assignedNeed.debut}→${assignedNeed.fin})`;
        } else if (d.needId) {
             needInfo = ` (Besoin ID ${d.needId} - Introuvable)`;
        }

        switch(d.status) {
            case 'assigned':
                statusText = `– Affectation RESPECTÉE${needInfo}.`;
                break;
            case 'conflict_metier':
                statusText = `– CONFLIT : Métier (${emp.metier || 'N/A'}) non requis.`;
                solutionText = `**Action :** Le projet n'a pas de besoin pour ce métier.`;
                break;
            case 'conflict_dispo':
                statusText = `– CONFLIT : Employé indisponible (${emp.disponibilite || 'N/A'}).`;
                solutionText = `**Action :** Mettre à jour la disponibilité.`;
                break;
            case 'conflict_slots':
                statusText = `– CONFLIT : Slots complets pour un besoin compatible.`;
                solutionText = `**Action :** Augmenter les slots dans le formulaire Projet.`;
                break;
            case 'conflict_overlap':
                const conflictNeed = getNeedByRef(d.conflitNeedRef);
                statusText = `– CONFLIT : Chevauchement avec ${d.conflitNeedRef.projectId} (${conflictNeed ? conflictNeed.metier : 'N/A'}).`;
                solutionText = `**Action :** Examiner les dates. Proposer un échange.`;
                break;
            case 'conflict_proj_not_found':
                statusText = `– CONFLIT : Projet ${d.projectId} introuvable.`;
                solutionText = `**Action :** Vérifier l'ID du projet.`;
                break;
            default:
                statusText = '– Échec de l\'affectation.';
                break;
        }

        let solutionHtml = solutionText ? `<div class="fixed-item-solution">${solutionText}</div>` : '';

        div.innerHTML = `
          <div class="fixed-item-content">
            • <span>${emp.nom}</span> doit être affecté à <span>${proj.id}</span>
            <div class="${d.status === 'assigned' ? 'fixed-item-success' : 'fixed-item-error'}">
              ${statusText}
            </div>
            ${solutionHtml}
          </div>
          <button class="delete-fixed-btn" data-index="${index}">X</button>
        `;
        fixedList.appendChild(div);
      });
      
      fixedList.querySelectorAll('.delete-fixed-btn').forEach(button => {
        button.addEventListener('click', (e) => {
          const index = e.target.getAttribute('data-index'); 
          removeFixedAssignment(parseInt(index));
        });
      });
    }

    function removeFixedAssignment(index) {
        fixedAssignments.splice(index, 1);
        renderFixedList();
        // Optionnel: relancer la planif après suppression d'une directive
        const result = planAllProjectsGlobally();
        if (result) renderAssignments(result);
    }

    function renderAssignments(result) {
      const { assignments, employeeAssignments, employeeLoad } = result;

      let totalSlots = projects.reduce((sum, p) => sum + p.needs.reduce((nSum, n) => nSum + n.slots, 0), 0);
      
      // Calculate total assigned slots
      let totalAssigned = 0;
      for (const projectId in assignments) {
          for (const needId in assignments[projectId]) {
              totalAssigned += assignments[projectId][needId].length;
          }
      }

      summaryText.textContent =
        `Postes remplis : ${totalAssigned}/${totalSlots} • ` +
        `Employés utilisés : ${Object.keys(employeeAssignments).filter(id => employeeAssignments[id].length > 0).length}/${employees.length}`;

      assignmentsContainer.innerHTML = "";

      // Sort by the earliest start date of any need in the project
      const projectsWithSortKey = projects.map(p => {
          const minDate = p.needs.reduce((min, n) => (min === null || parseDate(n.debut) < min) ? parseDate(n.debut) : min, null);
          return { ...p, sortDate: minDate };
      });
      const sortedProjects = projectsWithSortKey.sort((a, b) => a.sortDate - b.sortDate);

      for (const p of sortedProjects) {
        const block = document.createElement("div");
        block.className = "project-block";

        const totalSlotsProj = p.needs.reduce((sum, n) => sum + n.slots, 0);
        const totalAssignedProj = Object.values(assignments[p.id] || {}).reduce((sum, arr) => sum + arr.length, 0);
        
        const title = document.createElement("div");
        title.className = "project-block-title";
        title.innerHTML = `
          <h3>${p.id} – ${p.nom}</h3>
          <span>Affectation: ${totalAssignedProj}/${totalSlotsProj} slots remplis sur ${p.needs.length} besoins.</span>
        `;
        block.appendChild(title);

        // NOUVEAU: Aplatir les affectations pour tous les besoins du projet
        let allProjectAssignments = [];
        if (assignments[p.id]) {
            for (const need of p.needs) {
                const needAssignments = assignments[p.id][need.needId] || [];
                needAssignments.forEach(a => {
                    allProjectAssignments.push({ ...a, needDetails: need });
                });
            }
        }
        
        // Tri par score (le meilleur d'abord)
        allProjectAssignments.sort((a, b) => b.s.finalScore - a.s.finalScore);
        
        const list = document.createElement("div");
        list.className = "assignment-list-flat";
        
        if (allProjectAssignments.length === 0) {
            const no = document.createElement("div");
            no.className = "no-assign";
            no.textContent = `Aucun employé n'a pu être affecté à ce projet.`;
            list.appendChild(no);
        } else {
            for (const { emp, s, isFixed, needDetails } of allProjectAssignments) {
                const card = document.createElement("div");
                card.className = "assignment-card" + (isFixed ? ' fixed-assignment' : '');

                const finalScorePercentage = (s.finalScore * 100).toFixed(1);

                const top = document.createElement("div");
                top.className = "assignment-top";
                top.innerHTML = `
                  <span class="name">${emp.nom} ${isFixed ? '⭐ (Directive)' : ''}</span>
                  <div class="score-label">Score : ${finalScorePercentage}%</div>
                `;
                
                const scoreBar = document.createElement('div');
                scoreBar.className = 'score-bar-container';
                scoreBar.innerHTML = `<div class="score-bar" style="width: ${finalScorePercentage}%;"></div>`;

                const pills = document.createElement("div");
                pills.className = "pill-row";
                pills.innerHTML = `
                  <span>Métier: ${emp.metier || 'N/A'}</span>
                  <span>Éval : ${(emp.evaluation || 0).toFixed(1)}/5</span>
                  <span>Dist : ${emp.distanceKm || 'N/A'} km</span>
                  <span>Affect. tot. : ${employeeLoad[emp.id] || 1}</span>
                  <span>Dispo : ${emp.disponibilite || 'N/A'}</span>
                `;

                const detail = document.createElement("div");
                detail.className = "assignment-detail";
                detail.innerHTML = `
                  **Besoin Spécifique (ID ${needDetails.needId} - ${needDetails.metier}) :**
                  <br/>
                  Période: **${needDetails.debut} → ${needDetails.fin}**
                  <br/>
                  Compétences : ${(emp.competences || []).join(", ")}
                  <br/>
                  Match requis : <strong>${(s.matched || 0)}/${(needDetails.competencesRequises || []).length}</strong> (Requis : ${(needDetails.competencesRequises || []).join(", ")})
                  <br/>
                  Détail du score pondéré :
                  <ul>
                    <li>Compétences (50%) : ${(s.competenceScore * 50).toFixed(1)} / 50</li>
                    <li>Évaluation (30%) : ${(s.evalScore * 30).toFixed(1)} / 30</li>
                    <li>Distance (20%) : ${(s.distanceScore * 20).toFixed(1)} / 20</li>
                    <li>Facteur de charge : ${(s.loadFactor * 100).toFixed(0)}%</li>
                  </ul>
                `;

                card.appendChild(top);
                card.appendChild(scoreBar);
                card.appendChild(pills);
                card.appendChild(detail);
                list.appendChild(card);
            }
        }
        
        block.appendChild(list);
        assignmentsContainer.appendChild(block);
      }
      
      renderFixedList();
    }

    function initFixedSelectors() {
      if (!employees.length || !projects.length) {
        fixedProjectSelect.innerHTML = '<option>Aucune donnée chargée</option>';
        fixedEmployeeSelect.innerHTML = '<option>Aucune donnée chargée</option>';
        return;
      }

      fixedProjectSelect.innerHTML = '';
      fixedEmployeeSelect.innerHTML = '';

      projects.forEach(p => {
        const metiers = [...new Set(p.needs.map(n => n.metier))].join(', ');
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = `${p.id} – ${p.nom} (Métiers: ${metiers})`;
        fixedProjectSelect.appendChild(opt);
      });

      employees.forEach(e => {
        const opt = document.createElement("option");
        opt.value = e.id;
        opt.textContent = `${e.nom} (${e.metier || 'N/A'} - ${e.id} | Dispo: ${e.disponibilite || 'N/A'})`;
        fixedEmployeeSelect.appendChild(opt);
      });
    }

    // ===========================================
    // ÉVÉNEMENTS
    // ===========================================
    
    // Événements de planification
    planAllBtn.addEventListener("click", () => {
      const result = planAllProjectsGlobally();
      if (result) renderAssignments(result);
    });

    // Événements de gestion des données
    loadDataBtn.addEventListener("click", loadDataFromUI);
    saveDataBtn.addEventListener("click", saveDataToLocalStorage);
    resetDataBtn.addEventListener("click", resetDataToDefault);
    
    // Événements de gestion de projet (Header)
    saveProjectHeaderBtn.addEventListener('click', saveProjectHeader);
    cancelEditBtn.addEventListener('click', (e) => {
        e.preventDefault();
        resetProjectForm();
    });
    
    // Événements de gestion de besoin (Need)
    saveNeedBtn.addEventListener('click', saveNeed);
    cancelNeedEditBtn.addEventListener('click', (e) => {
        e.preventDefault();
        resetNeedForm();
    });

    // Ajouter une directive fixe
    document.getElementById("addFixedBtn").addEventListener("click", () => {
      const projectId = fixedProjectSelect.value;
      const empId = fixedEmployeeSelect.value;
      if (!projectId || !empId) return;

      const exists = fixedAssignments.some(
        d => d.projectId === projectId && d.empId === empId
      );
      // NOTE: We don't check for needId here, as the planning logic will find the best fitting need.
      if (!exists) {
        fixedAssignments.push({ projectId, empId, status: 'pending', reason: null }); 
        renderFixedList();
      }
    });

    // Effacer toutes les directives
    document.getElementById("clearFixedBtn").addEventListener("click", () => {
      fixedAssignments = [];
      renderFixedList();
      summaryText.textContent = "Toutes les directives ont été effacées. Cliquez sur 'Générer une nouvelle planification (IA)' pour mettre à jour les affectations.";
    });

    // Initialisation au chargement
    document.addEventListener('DOMContentLoaded', initializeData);
  </script>
</body>
</html>